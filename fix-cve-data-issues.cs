#!/usr/bin/env dotnet

using System.Text.Json;
using System.Text.Json.Nodes;
using System.Text.Encodings.Web;

var cveFiles = Directory.GetFiles(".", "cve.json", SearchOption.AllDirectories)
    .Where(f => f.Contains("release-notes/archives/"))
    .ToList();

Console.WriteLine($"Found {cveFiles.Count} CVE files to check and fix");

var options = new JsonSerializerOptions
{
    WriteIndented = true,
    Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
};

int totalIssues = 0;

foreach (var file in cveFiles)
{
    var jsonText = File.ReadAllText(file);
    var doc = JsonNode.Parse(jsonText) as JsonObject;
    
    if (doc == null)
    {
        Console.WriteLine($"  ERROR: Could not parse {file}");
        continue;
    }
    
    int fileIssues = 0;
    
    // Fix CVEs
    if (doc.ContainsKey("cves") && doc["cves"] is JsonArray cves)
    {
        foreach (var cveNode in cves.Cast<JsonObject>())
        {
            // Fix missing cna field
            if (!cveNode.ContainsKey("cna"))
            {
                cveNode["cna"] = "microsoft";
                fileIssues++;
                Console.WriteLine($"  {file}: Added missing 'cna' field to {cveNode["id"]}");
            }
            
            // Fix null description
            if (cveNode["description"] == null)
            {
                cveNode["description"] = new JsonArray();
                fileIssues++;
                Console.WriteLine($"  {file}: Fixed null description for {cveNode["id"]}");
            }
        }
    }
    
    if (fileIssues > 0)
    {
        var newJson = doc.ToJsonString(options);
        File.WriteAllText(file, newJson + "\n");
        totalIssues += fileIssues;
    }
}

Console.WriteLine($"\nCompleted: Fixed {totalIssues} issues across {cveFiles.Count} files");
