#!/usr/bin/env dotnet

using System.Text.Json;
using System.Text.Json.Nodes;
using System.Text.Encodings.Web;

// Find all cve.json files
var cveFiles = Directory.GetFiles(".", "cve.json", SearchOption.AllDirectories)
    .Where(f => f.Contains("release-notes/archives/"))
    .ToList();

Console.WriteLine($"Found {cveFiles.Count} CVE files to migrate");

var options = new JsonSerializerOptions
{
    WriteIndented = true,
    Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
};

foreach (var file in cveFiles)
{
    Console.WriteLine($"Processing: {file}");
    
    var jsonText = File.ReadAllText(file);
    var doc = JsonNode.Parse(jsonText) as JsonObject;
    
    if (doc == null)
    {
        Console.WriteLine($"  ERROR: Could not parse {file}");
        continue;
    }
    
    // Step 1: Rename "extensions" to "packages"
    if (doc.ContainsKey("extensions"))
    {
        var extensions = doc["extensions"]?.DeepClone();
        doc.Remove("extensions");
        doc["packages"] = extensions;
        Console.WriteLine("  - Renamed 'extensions' to 'packages'");
    }
    else if (!doc.ContainsKey("packages"))
    {
        // If neither exists, create empty packages array
        doc["packages"] = new JsonArray();
        Console.WriteLine("  - Added empty 'packages' array");
    }
    
    // Step 2: Ensure all products have required fields
    if (doc.ContainsKey("products") && doc["products"] is JsonArray products)
    {
        foreach (var product in products.Cast<JsonObject>())
        {
            // Ensure min_vulnerable, max_vulnerable, fixed exist
            if (!product.ContainsKey("min_vulnerable"))
            {
                product["min_vulnerable"] = "";
            }
            if (!product.ContainsKey("max_vulnerable"))
            {
                product["max_vulnerable"] = "";
            }
            if (!product.ContainsKey("fixed"))
            {
                product["fixed"] = "";
            }
        }
    }
    
    // Step 3: Ensure all packages have required fields
    if (doc.ContainsKey("packages") && doc["packages"] is JsonArray packages)
    {
        foreach (var package in packages.Cast<JsonObject>())
        {
            // Ensure min_vulnerable, max_vulnerable, fixed exist
            if (!package.ContainsKey("min_vulnerable"))
            {
                package["min_vulnerable"] = "";
            }
            if (!package.ContainsKey("max_vulnerable"))
            {
                package["max_vulnerable"] = "";
            }
            if (!package.ContainsKey("fixed"))
            {
                package["fixed"] = "";
            }
        }
    }
    
    // Step 4: Reorder top-level properties according to schema
    var orderedDoc = new JsonObject();
    
    // Required fields in order
    if (doc.ContainsKey("last_updated")) orderedDoc["last_updated"] = doc["last_updated"]?.DeepClone();
    if (doc.ContainsKey("title")) orderedDoc["title"] = doc["title"]?.DeepClone();
    if (doc.ContainsKey("cves")) orderedDoc["cves"] = doc["cves"]?.DeepClone();
    if (doc.ContainsKey("products")) orderedDoc["products"] = doc["products"]?.DeepClone();
    if (doc.ContainsKey("packages")) orderedDoc["packages"] = doc["packages"]?.DeepClone();
    
    // Optional fields (alphabetically after required)
    if (doc.ContainsKey("commits")) orderedDoc["commits"] = doc["commits"]?.DeepClone();
    if (doc.ContainsKey("cve_commits")) orderedDoc["cve_commits"] = doc["cve_commits"]?.DeepClone();
    if (doc.ContainsKey("cve_releases")) orderedDoc["cve_releases"] = doc["cve_releases"]?.DeepClone();
    if (doc.ContainsKey("product_cves")) orderedDoc["product_cves"] = doc["product_cves"]?.DeepClone();
    if (doc.ContainsKey("product_name")) orderedDoc["product_name"] = doc["product_name"]?.DeepClone();
    if (doc.ContainsKey("release_cves")) orderedDoc["release_cves"] = doc["release_cves"]?.DeepClone();
    
    // Write back
    var newJson = orderedDoc.ToJsonString(options);
    File.WriteAllText(file, newJson + "\n");
    
    Console.WriteLine($"  âœ“ Migrated successfully");
}

Console.WriteLine($"\nCompleted migration of {cveFiles.Count} files");
